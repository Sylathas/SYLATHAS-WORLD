<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sylathas World – Admin</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background: #0b0c10;
            color: #f5f5f5;
        }

        header {
            padding: 1rem 1.5rem;
            background: #1f2833;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        header h1 {
            margin: 0;
            font-size: 1.25rem;
        }

        header span {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        main {
            padding: 1rem 1.5rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .tab-btn {
            border: none;
            padding: 0.5rem 0.9rem;
            border-radius: 6px;
            background: #1f2833;
            color: inherit;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .tab-btn.active {
            background: #45a29e;
            color: #0b0c10;
            font-weight: 600;
        }

        .section {
            display: none;
            border-radius: 10px;
            background: #1f2833;
            padding: 1rem;
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.5);
        }

        .section.active {
            display: block;
        }

        .section h2 {
            margin-top: 0;
            font-size: 1.1rem;
        }

        .grid {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
            gap: 1rem;
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th,
        td {
            padding: 0.35rem 0.4rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        th {
            text-align: left;
            background: rgba(255, 255, 255, 0.03);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, 0.06);
            cursor: pointer;
        }

        .list-wrapper {
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            max-height: 420px;
            overflow: auto;
        }

        label {
            font-size: 0.8rem;
            opacity: 0.85;
            display: block;
            margin-top: 0.6rem;
            margin-bottom: 0.15rem;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            box-sizing: border-box;
            padding: 0.4rem 0.45rem;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(0, 0, 0, 0.35);
            color: inherit;
            font-family: inherit;
            font-size: 0.85rem;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        input[readonly] {
            opacity: 0.7;
        }

        .field-row {
            display: flex;
            gap: 0.5rem;
        }

        .field-row>div {
            flex: 1;
        }

        .btn-row {
            margin-top: 0.8rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .btn {
            border-radius: 999px;
            border: none;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            cursor: pointer;
            background: #45a29e;
            color: #0b0c10;
            font-weight: 600;
        }

        .btn.secondary {
            background: transparent;
            color: #c5c6c7;
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .btn.danger {
            background: #c3073f;
            color: #f5f5f5;
        }

        small {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        .pill {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 999px;
            font-size: 0.7rem;
            background: rgba(255, 255, 255, 0.1);
        }

        .status-bar {
            margin-top: 0.75rem;
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .status-bar span {
            opacity: 0.75;
        }

        .muted {
            opacity: 0.7;
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.75rem;
        }
    </style>
</head>

<body>
    <header>
        <h1>Sylathas World – Admin</h1>
        <span>Be careful: this edits live Firestore data.</span>
    </header>

    <main>
        <div class="tabs">
            <button class="tab-btn active" data-target="rooms-section">Room texts</button>
            <button class="tab-btn" data-target="vault-section">Vault</button>
            <button class="tab-btn" data-target="work-section">Work</button>
        </div>

        <section id="rooms-section" class="section active">
            <h2>Room texts</h2>
            <div class="grid">
                <div>
                    <div class="list-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Room</th>
                                    <th>Text (preview)</th>
                                </tr>
                            </thead>
                            <tbody id="rooms-list"></tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <label for="room-id">Document ID <span class="muted">(auto for new)</span></label>
                    <input id="room-id" type="text" readonly>

                    <label for="room-room">Room key <span class="muted">(e.g. "0intro")</span></label>
                    <input id="room-room" type="text">

                    <label for="room-text">Desktop text (Markdown)</label>
                    <textarea id="room-text"></textarea>

                    <label for="room-mobile-text">Mobile text (Markdown)</label>
                    <textarea id="room-mobile-text"></textarea>

                    <div class="btn-row">
                        <button class="btn secondary" id="room-new">New</button>
                        <button class="btn" id="room-save">Save / Update</button>
                        <button class="btn danger" id="room-delete">Delete</button>
                        <button class="btn secondary" id="room-refresh">Refresh list</button>
                    </div>

                    <div class="status-bar"><span id="rooms-status">Ready.</span></div>
                </div>
            </div>
        </section>

        <section id="vault-section" class="section">
            <h2>Vault</h2>
            <div class="grid">
                <div>
                    <div class="list-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Type</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="vault-list"></tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <label for="vault-id">Document ID <span class="muted">(auto for new)</span></label>
                    <input id="vault-id" type="text" readonly>

                    <div class="field-row">
                        <div>
                            <label for="vault-title">Title</label>
                            <input id="vault-title" type="text">
                        </div>
                        <div>
                            <label for="vault-type">Vault type</label>
                            <select id="vault-type">
                                <option value="3blog">3blog</option>
                                <option value="0projectfiles">0projectfiles</option>
                            </select>
                        </div>
                    </div>

                    <label>Created on</label>
                    <input id="vault-created" type="text" readonly>

                    <label for="vault-text">Text (Markdown)</label>
                    <textarea id="vault-text"></textarea>

                    <label for="vault-downloadable">Downloadable file URL</label>
                    <input id="vault-downloadable" type="text">
                    <small>Use the upload button to send a file to Firebase Storage, then this field will be filled with
                        its URL.</small>

                    <label for="vault-download-file">Upload downloadable file</label>
                    <input id="vault-download-file" type="file">

                    <label for="vault-images">Images URLs (one per line)</label>
                    <textarea id="vault-images"></textarea>
                    <label for="vault-images-files">Upload image(s)</label>
                    <input id="vault-images-files" type="file" accept="image/*" multiple>
                    <small>Uploaded images will append their download URLs to the list above.</small>

                    <div class="btn-row">
                        <button class="btn secondary" id="vault-new">New</button>
                        <button class="btn" id="vault-save">Save / Update</button>
                        <button class="btn danger" id="vault-delete">Delete</button>
                        <button class="btn secondary" id="vault-refresh">Refresh list</button>
                    </div>

                    <div class="status-bar"><span id="vault-status">Ready.</span></div>
                </div>
            </div>
        </section>

        <section id="work-section" class="section">
            <h2>Work</h2>
            <div class="grid">
                <div>
                    <div class="list-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody id="work-list"></tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <label for="work-id">Document ID <span class="muted">(auto for new)</span></label>
                    <input id="work-id" type="text" readonly>

                    <label for="work-title">Project title</label>
                    <input id="work-title" type="text">

                    <label for="work-type">Type</label>
                    <select id="work-type">
                        <option value="0Animations">0Animations</option>
                        <option value="1PromotionalContent">1PromotionalContent</option>
                        <option value="3Exhibits">3Exhibits</option>
                        <option value="2InteractiveStuff">2InteractiveStuff</option>
                    </select>

                    <label for="work-description">Description (Markdown)</label>
                    <textarea id="work-description"></textarea>

                    <label for="work-credits">Credits (Markdown)</label>
                    <textarea id="work-credits"></textarea>

                    <label for="work-youtube">YouTube URLs (one per line)</label>
                    <textarea id="work-youtube"></textarea>

                    <label for="work-images">Images URLs (one per line)</label>
                    <textarea id="work-images"></textarea>

                    <label for="work-images-files">Upload image(s)</label>
                    <input id="work-images-files" type="file" accept="image/*" multiple>
                    <small>Uploaded images will append their download URLs to the list above.</small>

                    <div class="btn-row">
                        <button class="btn secondary" id="work-new">New</button>
                        <button class="btn" id="work-save">Save / Update</button>
                        <button class="btn danger" id="work-delete">Delete</button>
                        <button class="btn secondary" id="work-refresh">Refresh list</button>
                    </div>

                    <div class="status-bar"><span id="work-status">Ready.</span></div>
                </div>
            </div>
        </section>
    </main>

    <script type="module">
        import {
            collection,
            getDocs,
            addDoc,
            updateDoc,
            deleteDoc,
            doc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";
        import { db } from "./firebase.js";

        const storage = getStorage();

        const $ = (id) => document.getElementById(id);

        const formatDate = (ts) => {
            if (!ts) return "";
            try {
                const d = ts.toDate ? ts.toDate() : new Date(ts);
                return d.toLocaleString();
            } catch {
                return "";
            }
        };

        const setStatus = (el, msg) => {
            el.textContent = msg;
        };

        const uploadFileToPath = async (file, pathPrefix) => {
            const safeName = file.name.replace(/[^\w.\-]/g, "_");
            const fullPath = `${pathPrefix}/${Date.now()}_${safeName}`;
            const storageRef = ref(storage, fullPath);
            await uploadBytes(storageRef, file);
            return await getDownloadURL(storageRef);
        };

        const uploadMultipleFiles = async (files, pathPrefix, existingList, statusEl) => {
            if (!files || files.length === 0) return existingList;
            const urls = [...existingList];
            for (const file of files) {
                setStatus(statusEl, `Uploading "${file.name}"...`);
                const url = await uploadFileToPath(file, pathPrefix);
                urls.push(url);
            }
            setStatus(statusEl, "Upload completed.");
            return urls;
        };

        const parseLines = (text) =>
            text
                .split("\n")
                .map((l) => l.trim())
                .filter((l) => l.length > 0);

        const linesToText = (arr) => (arr && arr.length ? arr.join("\n") : "");

        // Tabs
        document.querySelectorAll(".tab-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
                document.querySelectorAll(".tab-btn").forEach((b) => b.classList.remove("active"));
                document.querySelectorAll(".section").forEach((s) => s.classList.remove("active"));
                btn.classList.add("active");
                const target = btn.getAttribute("data-target");
                document.getElementById(target).classList.add("active");
            });
        });

        /////////////////////
        // ROOM_TEXTS
        /////////////////////

        let roomDocs = [];

        const loadRooms = async () => {
            setStatus($("rooms-status"), "Loading room_texts...");
            const snap = await getDocs(collection(db, "room_texts"));
            roomDocs = [];
            snap.forEach((d) => roomDocs.push({ id: d.id, ...d.data() }));
            const tbody = $("rooms-list");
            tbody.innerHTML = "";
            roomDocs
                .sort((a, b) => (a.room || "").localeCompare(b.room || ""))
                .forEach((doc) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td><span class="mono">${doc.room || ""}</span></td>
                        <td>${(doc.text || "").slice(0, 40)}${(doc.text || "").length > 40 ? "…" : ""}</td>
                    `;
                    tr.addEventListener("click", () => selectRoomDoc(doc.id));
                    tbody.appendChild(tr);
                });
            setStatus($("rooms-status"), `Loaded ${roomDocs.length} document(s).`);
        };

        const selectRoomDoc = (id) => {
            const docData = roomDocs.find((d) => d.id === id);
            if (!docData) return;
            $("room-id").value = docData.id;
            $("room-room").value = docData.room || "";
            $("room-text").value = docData.text || "";
            $("room-mobile-text").value = docData.mobile_text || "";
        };

        $("room-new").addEventListener("click", () => {
            $("room-id").value = "";
            $("room-room").value = "";
            $("room-text").value = "";
            $("room-mobile-text").value = "";
            setStatus($("rooms-status"), "Ready to create a new document.");
        });

        $("room-refresh").addEventListener("click", loadRooms);

        $("room-save").addEventListener("click", async () => {
            const id = $("room-id").value.trim();
            const data = {
                room: $("room-room").value.trim(),
                text: $("room-text").value,
                mobile_text: $("room-mobile-text").value
            };
            if (!data.room) {
                alert("Room key cannot be empty.");
                return;
            }
            try {
                if (id) {
                    await updateDoc(doc(db, "room_texts", id), data);
                    setStatus($("rooms-status"), "Document updated.");
                } else {
                    const refNew = await addDoc(collection(db, "room_texts"), data);
                    $("room-id").value = refNew.id;
                    setStatus($("rooms-status"), "New document created.");
                }
                await loadRooms();
            } catch (e) {
                console.error(e);
                setStatus($("rooms-status"), "Error saving document (see console).");
            }
        });

        $("room-delete").addEventListener("click", async () => {
            const id = $("room-id").value.trim();
            if (!id) {
                alert("Select a document first.");
                return;
            }
            if (!confirm("Delete this room_text document? This cannot be undone.")) return;
            try {
                await deleteDoc(doc(db, "room_texts", id));
                $("room-id").value = "";
                $("room-room").value = "";
                $("room-text").value = "";
                $("room-mobile-text").value = "";
                setStatus($("rooms-status"), "Document deleted.");
                await loadRooms();
            } catch (e) {
                console.error(e);
                setStatus($("rooms-status"), "Error deleting document (see console).");
            }
        });

        /////////////////////
        // VAULT
        /////////////////////

        let vaultDocs = [];

        const loadVault = async () => {
            setStatus($("vault-status"), "Loading vault...");
            const snap = await getDocs(collection(db, "vault"));
            vaultDocs = [];
            snap.forEach((d) => vaultDocs.push({ id: d.id, ...d.data() }));
            const tbody = $("vault-list");
            tbody.innerHTML = "";
            vaultDocs
                .slice()
                .sort((a, b) => {
                    const da = a.created_on && a.created_on.toMillis ? a.created_on.toMillis() : 0;
                    const dbv = b.created_on && b.created_on.toMillis ? b.created_on.toMillis() : 0;
                    return dbv - da;
                })
                .forEach((docData) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${docData.title || ""}</td>
                        <td><span class="pill mono">${docData.vault_type || ""}</span></td>
                        <td>${formatDate(docData.created_on)}</td>
                    `;
                    tr.addEventListener("click", () => selectVaultDoc(docData.id));
                    tbody.appendChild(tr);
                });
            setStatus($("vault-status"), `Loaded ${vaultDocs.length} document(s).`);
        };

        const selectVaultDoc = (id) => {
            const docData = vaultDocs.find((d) => d.id === id);
            if (!docData) return;
            $("vault-id").value = docData.id;
            $("vault-title").value = docData.title || "";
            $("vault-type").value = docData.vault_type || "3blog";
            $("vault-text").value = docData.text || "";
            $("vault-downloadable").value = docData.downloadable || "";
            $("vault-images").value = linesToText(docData.images || []);
            $("vault-created").value = formatDate(docData.created_on);
        };

        $("vault-new").addEventListener("click", () => {
            $("vault-id").value = "";
            $("vault-title").value = "";
            $("vault-type").value = "3blog";
            $("vault-text").value = "";
            $("vault-downloadable").value = "";
            $("vault-images").value = "";
            $("vault-created").value = "";
            setStatus($("vault-status"), "Ready to create a new document.");
        });

        $("vault-refresh").addEventListener("click", loadVault);

        $("vault-save").addEventListener("click", async () => {
            const id = $("vault-id").value.trim();
            const existing = vaultDocs.find((d) => d.id === id) || {};
            const data = {
                title: $("vault-title").value.trim(),
                vault_type: $("vault-type").value,
                text: $("vault-text").value,
                downloadable: $("vault-downloadable").value.trim() || "",
                images: parseLines($("vault-images").value)
            };
            if (!data.title) {
                alert("Title cannot be empty.");
                return;
            }
            try {
                if (id) {
                    await updateDoc(doc(db, "vault", id), data);
                    setStatus($("vault-status"), "Document updated.");
                } else {
                    data.created_on = serverTimestamp();
                    const refNew = await addDoc(collection(db, "vault"), data);
                    $("vault-id").value = refNew.id;
                    setStatus($("vault-status"), "New document created.");
                }
                await loadVault();
            } catch (e) {
                console.error(e);
                setStatus($("vault-status"), "Error saving document (see console).");
            }
        });

        $("vault-delete").addEventListener("click", async () => {
            const id = $("vault-id").value.trim();
            if (!id) {
                alert("Select a document first.");
                return;
            }
            if (!confirm("Delete this vault document? This cannot be undone.")) return;
            try {
                await deleteDoc(doc(db, "vault", id));
                $("vault-id").value = "";
                $("vault-title").value = "";
                $("vault-type").value = "3blog";
                $("vault-text").value = "";
                $("vault-downloadable").value = "";
                $("vault-images").value = "";
                $("vault-created").value = "";
                setStatus($("vault-status"), "Document deleted.");
                await loadVault();
            } catch (e) {
                console.error(e);
                setStatus($("vault-status"), "Error deleting document (see console).");
            }
        });

        $("vault-download-file").addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
                setStatus($("vault-status"), `Uploading "${file.name}"...`);
                const url = await uploadFileToPath(file, "vault_downloads");
                $("vault-downloadable").value = url;
                setStatus($("vault-status"), "Downloadable file uploaded and URL set.");
            } catch (err) {
                console.error(err);
                setStatus($("vault-status"), "Error uploading file (see console).");
            } finally {
                e.target.value = "";
            }
        });

        $("vault-images-files").addEventListener("change", async (e) => {
            const files = Array.from(e.target.files || []);
            if (!files.length) return;
            const current = parseLines($("vault-images").value);
            try {
                const urls = await uploadMultipleFiles(files, "vault_images", current, $("vault-status"));
                $("vault-images").value = linesToText(urls);
            } catch (err) {
                console.error(err);
                setStatus($("vault-status"), "Error uploading image(s) (see console).");
            } finally {
                e.target.value = "";
            }
        });

        /////////////////////
        // WORK
        /////////////////////

        let workDocs = [];

        const loadWork = async () => {
            setStatus($("work-status"), "Loading work...");
            const snap = await getDocs(collection(db, "work"));
            workDocs = [];
            snap.forEach((d) => workDocs.push({ id: d.id, ...d.data() }));
            const tbody = $("work-list");
            tbody.innerHTML = "";
            workDocs
                .slice()
                .sort((a, b) => (a.project_title || "").localeCompare(b.project_title || ""))
                .forEach((docData) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${docData.project_title || ""}</td>
                        <td><span class="pill mono">${docData.type || ""}</span></td>
                    `;
                    tr.addEventListener("click", () => selectWorkDoc(docData.id));
                    tbody.appendChild(tr);
                });
            setStatus($("work-status"), `Loaded ${workDocs.length} document(s).`);
        };

        const selectWorkDoc = (id) => {
            const docData = workDocs.find((d) => d.id === id);
            if (!docData) return;
            $("work-id").value = docData.id;
            $("work-title").value = docData.project_title || "";
            $("work-type").value = docData.type || "0Animations";
            $("work-description").value = docData.description_of_project || "";
            $("work-credits").value = docData.credits || "";
            $("work-youtube").value = linesToText((docData.youtube_ur_ls || "").split("\n").filter(Boolean));
            $("work-images").value = linesToText(docData.images || []);
        };

        $("work-new").addEventListener("click", () => {
            $("work-id").value = "";
            $("work-title").value = "";
            $("work-type").value = "0Animations";
            $("work-description").value = "";
            $("work-credits").value = "";
            $("work-youtube").value = "";
            $("work-images").value = "";
            setStatus($("work-status"), "Ready to create a new document.");
        });

        $("work-refresh").addEventListener("click", loadWork);

        $("work-save").addEventListener("click", async () => {
            const id = $("work-id").value.trim();
            const data = {
                project_title: $("work-title").value.trim(),
                type: $("work-type").value,
                description_of_project: $("work-description").value,
                credits: $("work-credits").value,
                youtube_ur_ls: $("work-youtube").value,
                images: parseLines($("work-images").value)
            };
            if (!data.project_title) {
                alert("Project title cannot be empty.");
                return;
            }
            try {
                if (id) {
                    await updateDoc(doc(db, "work", id), data);
                    setStatus($("work-status"), "Document updated.");
                } else {
                    const refNew = await addDoc(collection(db, "work"), data);
                    $("work-id").value = refNew.id;
                    setStatus($("work-status"), "New document created.");
                }
                await loadWork();
            } catch (e) {
                console.error(e);
                setStatus($("work-status"), "Error saving document (see console).");
            }
        });

        $("work-delete").addEventListener("click", async () => {
            const id = $("work-id").value.trim();
            if (!id) {
                alert("Select a document first.");
                return;
            }
            if (!confirm("Delete this work document? This cannot be undone.")) return;
            try {
                await deleteDoc(doc(db, "work", id));
                $("work-id").value = "";
                $("work-title").value = "";
                $("work-type").value = "0Animations";
                $("work-description").value = "";
                $("work-credits").value = "";
                $("work-youtube").value = "";
                $("work-images").value = "";
                setStatus($("work-status"), "Document deleted.");
                await loadWork();
            } catch (e) {
                console.error(e);
                setStatus($("work-status"), "Error deleting document (see console).");
            }
        });

        $("work-images-files").addEventListener("change", async (e) => {
            const files = Array.from(e.target.files || []);
            if (!files.length) return;
            const current = parseLines($("work-images").value);
            try {
                const urls = await uploadMultipleFiles(files, "work_images", current, $("work-status"));
                $("work-images").value = linesToText(urls);
            } catch (err) {
                console.error(err);
                setStatus($("work-status"), "Error uploading image(s) (see console).");
            } finally {
                e.target.value = "";
            }
        });

        // Initial load
        (async () => {
            await loadRooms();
            await loadVault();
            await loadWork();
        })();
    </script>
</body>

</html>


